# puxe uma imagem ARM64 e crie um tag local
docker pull --platform=linux/arm64 nginx:1.27-alpine
docker tag nginx:1.27-alpine nginx:local

# importe pro node do kind via streaming (não depende de arquivo dentro do container)
docker save nginx:local -o - | docker exec -i local-dev-control-plane ctr -n k8s.io images import -

# confirme que o node "vê" a imagem
docker exec -it local-dev-control-plane ctr -n k8s.io images ls | grep nginx


# imagens locais + pullPolicy=Never + desliga rollouts/analysis só no local
cat <<'EOF' > local-images.yaml
global:
  topologySpreadAz: false

picpay-ms-v2-qa:
  apis:
    - image: { repositoryURI: nginx, tag: local, pullPolicy: Never }
      rollouts: { enabled: false }
      analysis: { enabled: false }
      readiness: { httpGet: { path: / } }
      liveness:  { httpGet: { path: / } }
    - image: { repositoryURI: nginx, tag: local, pullPolicy: Never }
      rollouts: { enabled: false }
      analysis: { enabled: false }
      readiness: { httpGet: { path: / } }
      liveness:  { httpGet: { path: / } }
    - image: { repositoryURI: nginx, tag: local, pullPolicy: Never }
      rollouts: { enabled: false }
      analysis: { enabled: false }
      readiness: { httpGet: { path: / } }
      liveness:  { httpGet: { path: / } }
EOF



# requests/limits pequenos pro kind/colima
cat <<'EOF' > local-resources.yaml
picpay-ms-v2-qa:
  apis:
    - requests_memory: 128Mi
      limits_memory:   256Mi
      requests_cpu:    25m
      limits_cpu:      200m
    - requests_memory: 128Mi
      limits_memory:   256Mi
      requests_cpu:    25m
      limits_cpu:      200m
    - requests_memory: 128Mi
      limits_memory:   256Mi
      requests_cpu:    25m
      limits_cpu:      200m
EOF



helm upgrade --install ms-edi-pix . \
  -f values.qa.yaml \
  -f local-no-crds.yaml \
  -f local-images.yaml \
  -f local-resources.yaml \
  --namespace ms-edi-pix



kubectl -n ms-edi-pix delete pod -l app=edi-pix-bankpj || true
kubectl -n ms-edi-pix delete pod -l app=edi-pix-legacy || true
kubectl -n ms-edi-pix delete pod -l app=edi-pix-fnsvcpf || true

kubectl -n ms-edi-pix get deploy -o jsonpath='{range .items[*]}{.metadata.name}{" -> "}{.spec.template.spec.containers[*].image}{"\n"}{end}'
kubectl -n ms-edi-pix get pods
