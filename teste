@Aggregation(pipeline = {
        // 1) Agrupa por (projeto + member.login) para calcular score por membro em cada projeto
        "{ $group: { " +
                "  _id: { projectId: \"$projectId\", memberLogin: \"$member.login\" }, " +
                "  memberScore: { $sum: { $toDouble: { $ifNull: [ \"$score\", 0 ] } } }, " +
                "  totalOpenIssues: { $sum: { $cond: [ { $eq: [ \"$typeOfMetrics\", \"ISSUE-OPEN\" ] }, 1, 0 ] } }, " +
                "  totalClosedIssues: { $sum: { $cond: [ { $eq: [ \"$typeOfMetrics\", \"ISSUE-CLOSED\" ] }, 1, 0 ] } }, " +
                "  totalMergedPullRequests: { $sum: { $cond: [ { $eq: [ \"$typeOfMetrics\", \"PR-MERGED\" ] }, 1, 0 ] } }, " +
                "  totalUnmergedPullRequests: { $sum: { $cond: [ { $eq: [ \"$typeOfMetrics\", \"PR-UNMERGED\" ] }, 1, 0 ] } }, " +
                "  totalCommits: { $sum: { $cond: [ { $eq: [ \"$typeOfMetrics\", \"COMMIT\" ] }, 1, 0 ] } }, " +
                "  contributions: { $sum: 1 } " +
                "} }",

        // 2) Agrupa por projeto, soma tudo e monta a lista de membros
        "{ $group: { " +
                "  _id: \"$_id.projectId\", " +
                "  totalScore: { $sum: \"$memberScore\" }, " +
                "  totalOpenIssues: { $sum: \"$totalOpenIssues\" }, " +
                "  totalClosedIssues: { $sum: \"$totalClosedIssues\" }, " +
                "  totalMergedPullRequests: { $sum: \"$totalMergedPullRequests\" }, " +
                "  totalUnmergedPullRequests: { $sum: \"$totalUnmergedPullRequests\" }, " +
                "  totalCommits: { $sum: \"$totalCommits\" }, " +
                "  contributions: { $sum: \"$contributions\" }, " +
                "  members: { $addToSet: { \"login\": \"$_id.memberLogin\" } } " + // <- casa com Member.login
                "} }",

        // 3) Projeta no formato do ProjectRanking
        "{ $project: { " +
                "  _id: 0, " +
                "  name: \"$_id\", " + // ProjectRanking.name = projectId
                "  score: { $round: [\"$totalScore\", 1] }, " +
                "  totalOpenIssues: 1, " +
                "  totalClosedIssues: 1, " +
                "  totalMergedPullRequests: 1, " +
                "  totalUnmergedPullRequests: 1, " +
                "  totalCommits: 1, " +
                "  contributors: { $size: \"$members\" }, " +
                "  contributions: 1, " +
                "  members: 1 " +
                "} }",

        // 4) Ordena e limita
        "{ $sort: { score: -1 } }",
        "{ $limit: 5 }"
})
List<ProjectRanking> topProjectsWithMembers();
