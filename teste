public Double calculateCatalogGrowthCumulative(int months) {

        // mês atual (UTC) e mês alvo (UTC)
        ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);
        ZonedDateTime currentMonthStart = now.withDayOfMonth(1).toLocalDate().atStartOfDay(ZoneOffset.UTC);
        ZonedDateTime targetMonthStart  = currentMonthStart.minusMonths(months);

        Date currentMonth = Date.from(currentMonthStart.toInstant());
        Date targetMonth  = Date.from(targetMonthStart.toInstant());

        // Pipeline em Document (driver nativo)
        List<Document> pipeline = new ArrayList<>();

        // Só docs com participationPeriods como object
        pipeline.add(new Document("$match", new Document("participationPeriods", new Document("$type", "object"))));

        // Map -> array
        pipeline.add(new Document("$project", new Document()
            .append("_id", 1)
            .append("periods", new Document("$objectToArray", "$participationPeriods"))
        ));

        // Converte keys para Date e trunca pro mês
        pipeline.add(new Document("$set", new Document("months", new Document("$map", new Document()
            .append("input", "$periods")
            .append("as", "p")
            .append("in", new Document("$dateTrunc", new Document()
                .append("date", new Document("$dateFromString", new Document()
                    .append("dateString", "$$p.k")
                    .append("format", "%Y-%m-%d")
                ))
                .append("unit", "month")
            ))
        ))));

        // Pega o primeiro mês (menor) do doc => “mês de entrada”
        pipeline.add(new Document("$set", new Document("firstMonth",
            new Document("$min", "$months")
        )));

        // descarta docs sem firstMonth (caso extremo)
        pipeline.add(new Document("$match", new Document("firstMonth", new Document("$ne", null))));

        // calcula pastTotal e currentTotal no mesmo pipeline
        pipeline.add(new Document("$group", new Document()
            .append("_id", null)
            .append("pastTotal", new Document("$sum",
                new Document("$cond", List.of(
                    new Document("$lte", List.of("$firstMonth", targetMonth)),
                    1,
                    0
                ))
            ))
            .append("currentTotal", new Document("$sum",
                new Document("$cond", List.of(
                    new Document("$lte", List.of("$firstMonth", currentMonth)),
                    1,
                    0
                ))
            ))
        ));

        // percentual
        pipeline.add(new Document("$project", new Document()
            .append("_id", 0)
            .append("percentChange", new Document("$cond", List.of(
                new Document("$eq", List.of("$pastTotal", 0)),
                null,
                new Document("$multiply", List.of(
                    new Document("$divide", List.of(
                        new Document("$subtract", List.of("$currentTotal", "$pastTotal")),
                        "$pastTotal"
                    )),
                    100
                ))
            )))
        ));

        MongoCollection<Document> col = mongoTemplate.getDb().getCollection("catalog");
        Document out = col.aggregate(pipeline).first();

        if (out == null) return null;
        Object v = out.get("percentChange");
        return (v instanceof Number) ? ((Number) v).doubleValue() : null;
    }

public Double calculateMemberGrowthMonthly(int months) {

    Aggregation aggregation = /* EXATAMENTE o mesmo Aggregation acima */;

    AggregationResults<Document> result =
        mongoTemplate.aggregate(aggregation, "member", Document.class);

    Document doc = result.getUniqueMappedResult();
    return doc == null ? null : doc.getDouble("percentChange");
}
