public Double calculateCatalogGrowthMonthlyCumulative(int months) {

    // mês atual (UTC) e mês alvo
    var now = java.time.ZonedDateTime.now(java.time.ZoneOffset.UTC);
    var currentMonthStart = now.withDayOfMonth(1).toLocalDate().atStartOfDay(java.time.ZoneOffset.UTC);
    var targetMonthStart  = currentMonthStart.minusMonths(months);

    java.util.Date currentMonth = java.util.Date.from(currentMonthStart.toInstant());
    java.util.Date targetMonth  = java.util.Date.from(targetMonthStart.toInstant());

    Aggregation aggregation = Aggregation.newAggregation(

        // Map -> array
        context -> new org.bson.Document("$project", new org.bson.Document("periods",
            new org.bson.Document("$objectToArray", "$participationPeriods")
        )),

        // explode
        context -> new org.bson.Document("$unwind", "$periods"),

        // key string -> date (mês)
        context -> new org.bson.Document("$set", new org.bson.Document("month",
            new org.bson.Document("$dateTrunc", new org.bson.Document("date",
                new org.bson.Document("$dateFromString",
                    new org.bson.Document("dateString", "$periods.k").append("format", "%Y-%m-%d")
                )
            ).append("unit", "month"))
        )),

        // mantém só meses até o mês atual (descarta futuro, se existir)
        context -> new org.bson.Document("$match", new org.bson.Document("$expr",
            new org.bson.Document("$lte", java.util.List.of("$month", currentMonth))
        )),

        // dedup por docId+month (um doc pode ter múltiplas chaves no mesmo mês)
        context -> new org.bson.Document("$group", new org.bson.Document()
            .append("_id", new org.bson.Document("docId", "$_id").append("month", "$month"))
        ),

        // conta quantos docs “entram” por mês
        context -> new org.bson.Document("$group", new org.bson.Document()
            .append("_id", "$_id.month")
            .append("count", new org.bson.Document("$sum", 1))
        ),

        // agora calcula totals acumulados:
        // pastTotal = soma counts onde month <= targetMonth
        // currentTotal = soma counts onde month <= currentMonth
        context -> new org.bson.Document("$group", new org.bson.Document()
            .append("_id", null)
            .append("pastTotal", new org.bson.Document("$sum",
                new org.bson.Document("$cond", java.util.List.of(
                    new org.bson.Document("$lte", java.util.List.of("$_id", targetMonth)),
                    "$count",
                    0
                ))
            ))
            .append("currentTotal", new org.bson.Document("$sum",
                new org.bson.Document("$cond", java.util.List.of(
                    new org.bson.Document("$lte", java.util.List.of("$_id", currentMonth)),
                    "$count",
                    0
                ))
            ))
        ),

        // percentual
        context -> new org.bson.Document("$project", new org.bson.Document()
            .append("_id", 0)
            .append("percentChange", new org.bson.Document("$cond", java.util.List.of(
                new org.bson.Document("$eq", java.util.List.of("$pastTotal", 0)),
                null,
                new org.bson.Document("$multiply", java.util.List.of(
                    new org.bson.Document("$divide", java.util.List.of(
                        new org.bson.Document("$subtract", java.util.List.of("$currentTotal", "$pastTotal")),
                        "$pastTotal"
                    )),
                    100
                ))
            )))
        )
    );

    var result = mongoTemplate.aggregate(aggregation, "catalog", org.bson.Document.class);
    var doc = result.getUniqueMappedResult();
    return doc == null ? null : doc.getDouble("percentChange");
}

public Double calculateMemberGrowthMonthly(int months) {

    Aggregation aggregation = /* EXATAMENTE o mesmo Aggregation acima */;

    AggregationResults<Document> result =
        mongoTemplate.aggregate(aggregation, "member", Document.class);

    Document doc = result.getUniqueMappedResult();
    return doc == null ? null : doc.getDouble("percentChange");
}
