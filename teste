public Double calculateIssueOpenGrowthCumulative(int months) {

    ZoneId tz = ZoneId.of("America/Sao_Paulo"); // ou UTC, mas use o MESMO em tudo
    ZonedDateTime now = ZonedDateTime.now(tz);
    ZonedDateTime currentMonthStart = now.withDayOfMonth(1).toLocalDate().atStartOfDay(tz);
    ZonedDateTime targetMonthStart  = currentMonthStart.minusMonths(months);

    Date currentMonth = Date.from(currentMonthStart.toInstant());
    Date targetMonth  = Date.from(targetMonthStart.toInstant());

    List<Document> pipeline = new ArrayList<>();

    // 1) filtra ISSUE-OPEN e garante que registerAt existe
    pipeline.add(new Document("$match", new Document()
        .append("typeOfMetrics", "ISSUE-OPEN")
        .append("registerAt", new Document("$ne", null))
    ));

    // 2) converte registerAt para date (se já for date, ok; se for string, converte)
    pipeline.add(new Document("$set", new Document("registerAtDate",
        new Document("$toDate", "$registerAt")
    )));

    // 3) month = trunc(registerAtDate)
    pipeline.add(new Document("$set", new Document("month",
        new Document("$dateTrunc", new Document()
            .append("date", "$registerAtDate")
            .append("unit", "month")
            .append("timezone", "America/Sao_Paulo")
        )
    )));

    // 4) só até o mês atual
    pipeline.add(new Document("$match", new Document("$expr",
        new Document("$lte", Arrays.asList("$month", currentMonth))
    )));

    // 5) acumulados
    pipeline.add(new Document("$group", new Document()
        .append("_id", null)
        .append("pastTotal", new Document("$sum",
            new Document("$cond", Arrays.asList(
                new Document("$lte", Arrays.asList("$month", targetMonth)),
                1,
                0
            ))
        ))
        .append("currentTotal", new Document("$sum",
            new Document("$cond", Arrays.asList(
                new Document("$lte", Arrays.asList("$month", currentMonth)),
                1,
                0
            ))
        ))
    ));

    // 6) percentual
    pipeline.add(new Document("$project", new Document()
        .append("_id", 0)
        .append("percentChange", new Document("$cond", Arrays.asList(
            new Document("$eq", Arrays.asList("$pastTotal", 0)),
            null,
            new Document("$multiply", Arrays.asList(
                new Document("$divide", Arrays.asList(
                    new Document("$subtract", Arrays.asList("$currentTotal", "$pastTotal")),
                    "$pastTotal"
                )),
                100
            ))
        )))
    ));

    Document out = mongoTemplate.getDb().getCollection("metrics").aggregate(pipeline).first();
    if (out == null) return null;

    Object v = out.get("percentChange");
    return (v instanceof Number) ? ((Number) v).doubleValue() : null;
}
