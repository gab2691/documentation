import javax.crypto.Cipher;
import javax.crypto.spec.IvParameterSpec;
import javax.crypto.spec.SecretKeySpec;
import java.io.ByteArrayOutputStream;
import java.nio.charset.StandardCharsets;
import java.security.MessageDigest;
import java.security.SecureRandom;
import java.util.Arrays;
import java.util.Base64;

public class OpenSslSha256Aes {

    private static class KeyIv {
        final byte[] key;
        final byte[] iv;
        KeyIv(byte[] key, byte[] iv) { this.key = key; this.iv = iv; }
    }

    // EVP_BytesToKey_SHA256(passphrase, salt, keyLen=32, ivLen=16)
    private static KeyIv evpBytesToKeySha256(byte[] passphrase, byte[] salt,
                                             int keyLen, int ivLen) throws Exception {
        MessageDigest md = MessageDigest.getInstance("SHA-256");
        int totalLen = keyLen + ivLen;
        byte[] d = new byte[0];
        byte[] result = new byte[0];

        while (result.length < totalLen) {
            md.reset();
            md.update(d);
            md.update(passphrase);
            md.update(salt);
            d = md.digest();
            byte[] newResult = new byte[result.length + d.length];
            System.arraycopy(result, 0, newResult, 0, result.length);
            System.arraycopy(d, 0, newResult, result.length, d.length);
            result = newResult;
        }

        byte[] key = Arrays.copyOfRange(result, 0, keyLen);
        byte[] iv  = Arrays.copyOfRange(result, keyLen, totalLen);
        return new KeyIv(key, iv);
    }

    public static String encryptWithSha256Aes(String message, String passphrase) throws Exception {
        // 1) salt de 8 bytes
        byte[] salt = new byte[8];
        new SecureRandom().nextBytes(salt);

        // 2) key + iv via EVP_BytesToKey_SHA256
        KeyIv kiv = evpBytesToKeySha256(
                passphrase.getBytes(StandardCharsets.UTF_8),
                salt,
                32,
                16
        );

        SecretKeySpec keySpec = new SecretKeySpec(kiv.key, "AES");
        IvParameterSpec ivSpec = new IvParameterSpec(kiv.iv);

        // 3) AES/CBC/PKCS5Padding (equivalente ao Pkcs7 do CryptoJS)
        Cipher cipher = Cipher.getInstance("AES/CBC/PKCS5Padding");
        cipher.init(Cipher.ENCRYPT_MODE, keySpec, ivSpec);
        byte[] cipherBytes = cipher.doFinal(message.getBytes(StandardCharsets.UTF_8));

        // 4) "Salted__" + salt + ciphertext  â†’ Base64
        ByteArrayOutputStream out = new ByteArrayOutputStream();
        out.write("Salted__".getBytes(StandardCharsets.US_ASCII));
        out.write(salt);
        out.write(cipherBytes);

        return Base64.getEncoder().encodeToString(out.toByteArray());
    }
}
