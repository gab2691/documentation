public Double calculateCatalogGrowthCumulative(int months) {

        ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);
        ZonedDateTime currentMonthStart = now.withDayOfMonth(1).toLocalDate().atStartOfDay(ZoneOffset.UTC);
        ZonedDateTime targetMonthStart  = currentMonthStart.minusMonths(months);

        Date currentMonth = Date.from(currentMonthStart.toInstant());
        Date targetMonth  = Date.from(targetMonthStart.toInstant());

        List<Document> pipeline = new ArrayList<>();

        pipeline.add(new Document("$match",
            new Document("participationPeriods", new Document("$type", "object"))
        ));

        pipeline.add(new Document("$project", new Document()
            .append("_id", 1)
            .append("periods", new Document("$objectToArray", "$participationPeriods"))
        ));

        pipeline.add(new Document("$set", new Document("months", new Document("$map", new Document()
            .append("input", "$periods")
            .append("as", "p")
            .append("in", new Document("$dateTrunc", new Document()
                .append("date", new Document("$dateFromString", new Document()
                    .append("dateString", "$$p.k")
                    .append("format", "%Y-%m-%d")
                ))
                .append("unit", "month")
            ))
        ))));

        pipeline.add(new Document("$set", new Document("firstMonth",
            new Document("$min", "$months")
        )));

        pipeline.add(new Document("$match",
            new Document("firstMonth", new Document("$ne", null))
        ));

        pipeline.add(new Document("$group", new Document()
            .append("_id", null)
            .append("pastTotal", new Document("$sum",
                new Document("$cond", Arrays.asList(
                    new Document("$lte", Arrays.asList("$firstMonth", targetMonth)),
                    1,
                    0
                ))
            ))
            .append("currentTotal", new Document("$sum",
                new Document("$cond", Arrays.asList(
                    new Document("$lte", Arrays.asList("$firstMonth", currentMonth)),
                    1,
                    0
                ))
            ))
        ));

        pipeline.add(new Document("$project", new Document()
            .append("_id", 0)
            .append("percentChange", new Document("$cond", Arrays.asList(
                new Document("$eq", Arrays.asList("$pastTotal", 0)),
                null,
                new Document("$multiply", Arrays.asList(
                    new Document("$divide", Arrays.asList(
                        new Document("$subtract", Arrays.asList("$currentTotal", "$pastTotal")),
                        "$pastTotal"
                    )),
                    100
                ))
            )))
        ));

        MongoCollection<Document> col = mongoTemplate.getDb().getCollection("catalog");
        Document out = col.aggregate(pipeline).first();

        if (out == null) return null;
        Object v = out.get("percentChange");
        return (v instanceof Number) ? ((Number) v).doubleValue() : null;
    }
public Double calculateMemberGrowthMonthly(int months) {

    Aggregation aggregation = /* EXATAMENTE o mesmo Aggregation acima */;

    AggregationResults<Document> result =
        mongoTemplate.aggregate(aggregation, "member", Document.class);

    Document doc = result.getUniqueMappedResult();
    return doc == null ? null : doc.getDouble("percentChange");
}
