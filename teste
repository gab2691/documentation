public Double calculateMetricsMonthlyGrowth(int months) {

        String tz = "America/Sao_Paulo"; // mantenha consistente com seu negócio
        ZoneId zoneId = ZoneId.of(tz);

        ZonedDateTime now = ZonedDateTime.now(zoneId);
        ZonedDateTime currentMonthStart = now.withDayOfMonth(1).toLocalDate().atStartOfDay(zoneId);
        ZonedDateTime targetMonthStart  = currentMonthStart.minusMonths(months);

        Date currentStart = Date.from(currentMonthStart.toInstant());
        Date currentEnd   = Date.from(currentMonthStart.plusMonths(1).toInstant());

        Date targetStart  = Date.from(targetMonthStart.toInstant());
        Date targetEnd    = Date.from(targetMonthStart.plusMonths(1).toInstant());

        List<Document> pipeline = new ArrayList<>();

        // 1) garante que tem registerAt
        pipeline.add(new Document("$match", new Document("registerAt", new Document("$ne", null))));

        // 2) converte registerAt (se for string, converte; se já for date, ok)
        pipeline.add(new Document("$set", new Document("registerAtDate",
            new Document("$toDate", "$registerAt")
        )));

        // 3) calcula os dois counts em paralelo
        pipeline.add(new Document("$facet", new Document()
            .append("current", Arrays.asList(
                new Document("$match", new Document("registerAtDate", new Document()
                    .append("$gte", currentStart)
                    .append("$lt", currentEnd)
                )),
                new Document("$count", "count")
            ))
            .append("target", Arrays.asList(
                new Document("$match", new Document("registerAtDate", new Document()
                    .append("$gte", targetStart)
                    .append("$lt", targetEnd)
                )),
                new Document("$count", "count")
            ))
        ));

        // 4) extrai os counts (se vazio, vira 0)
        pipeline.add(new Document("$project", new Document()
            .append("currentCount", new Document("$ifNull", Arrays.asList(
                new Document("$first", "$current.count"), 0
            )))
            .append("targetCount", new Document("$ifNull", Arrays.asList(
                new Document("$first", "$target.count"), 0
            )))
        ));

        // 5) percentual
        pipeline.add(new Document("$project", new Document()
            .append("_id", 0)
            .append("percentChange", new Document("$cond", Arrays.asList(
                new Document("$eq", Arrays.asList("$targetCount", 0)),
                null,
                new Document("$multiply", Arrays.asList(
                    new Document("$divide", Arrays.asList(
                        new Document("$subtract", Arrays.asList("$currentCount", "$targetCount")),
                        "$targetCount"
                    )),
                    100
                ))
            )))
        ));

        MongoCollection<Document> col = mongoTemplate.getDb().getCollection("metrics"); // ajuste se o nome for outro
        Document out = col.aggregate(pipeline).first();

        if (out == null) return null;
        Object v = out.get("percentChange");
        return (v instanceof Number) ? ((Number) v).doubleValue() : null;
    }
